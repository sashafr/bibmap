<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title></title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
  <link rel="stylesheet" href="https://js.arcgis.com/4.4/esri/css/main.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://js.arcgis.com/4.4/"></script>

  <script>
  require([
    "esri/Map",
    "esri/WebMap",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/geometry/Point",
    "esri/geometry/Polygon",
    "esri/geometry/Circle",
    "esri/geometry/Polyline",
    "esri/geometry/SpatialReference",
    "esri/geometry/Extent",
    "esri/Graphic",
    "esri/Color",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/layers/GraphicsLayer",
    "esri/symbols/SimpleFillSymbol",
    "esri/symbols/SimpleLineSymbol",
    "esri/tasks/QueryTask",
    "esri/tasks/support/Query",
    "esri/tasks/support/StatisticDefinition",
    "esri/geometry/geometryEngine",
    "esri/widgets/Search",
    "esri/widgets/Popup",
    "esri/PopupTemplate",
    "esri/core/watchUtils",
    "dojo/dom",
    "dojo/domReady!",
    "dojo/ready"
  ],

  function(Map, WebMap, MapView, FeatureLayer, Point, Polygon, Circle, Polyline, SpatialReference, Extent, Graphic, Color, SimpleMarkerSymbol, GraphicsLayer, SimpleFillSymbol, SimpleLineSymbol, QueryTask,
    Query, StatisticDefinition, geometryEngine, Search, Popup, PopupTemplate, watchUtils, dom){

      //------------------------------INITIALIZE MAP AND VARIABLES---------------------------------------
      var polygon;
      var geometry;
      var layer;
      var centroidLayer;
      var centroidLayer2;
      var selectedPoints = new GraphicsLayer();
      var selectedPointsGraphics;
      var biblioFeatures;
      var searchByCircle = false;
      var drawing = false;
      var biblioFeatures2 = [];
      var biblioFeatures3;
      var searchArea;
      var layerExtent;
      var listOfAuthorFields = [];
      var listOfFirstNameFields = [];
      var listOfLastNameFields = [];
      var englishTitle;
      var turkishTitle;
      var otherTitle;
      var publication;
      var language;
      var pageStart;
      var pageEnd;
      var volume;
      var number;
      var listOfLayers = [];
      var listOfCentroids = [];
      var listOfBiblioFeatures2 = [];
      var searchList = [];
      var allRecords = document.getElementById("allRecords");
      var resultsShowing;
      var clicks = 0;
      var firstPoint;
      var secondPoint;
      var lineSymbol = {
        type: "simple-line",
        color: "lightblue",
        width: "10px",
        style: "short-dot"
      };
      var line = new Polyline();
      var smallestX;
      var smallestY;
      var biggestX;
      var biggestY;

      var drawConfig = {
        drawingSymbol: new SimpleFillSymbol({
          color: [102, 0, 255, 0.15],
          outline: {
            color: "#6600FF",
            width: 2
          }
        }),
        finishedSymbol: new SimpleFillSymbol({
          color: [102, 0, 255, 0.45],
          outline: {
            color: "#6600FF",
            width: 2
          }
        }),
        activePolygon: null,
        isDrawActive: false
      };

      //initialize the webmap and view
      var map = new WebMap({
        portalItem: { // autocasts as new PortalItem()
          id: "b6af77794c9844b38bd52aec61f7db84"
        }
      })

      var view = new MapView({
        container: "viewDiv",  // Reference to the scene div created in step 5
        map: map,  // Reference to the map object created before the scene
        zoom: 7,  // Sets zoom level based on level of detail (LOD)
        center: [29.5, 40]  // Sets center point of view using longitude,latitude
      });

      var searchWidget = new Search({
        view: view,
        resultGraphicEnabled: false,
        popupEnabled: false,
        popupOpenOnSelect: false,
      });

      var checkedList = [];
      var nameList;

      //Add buttons
      view.ui.add("draw-button", "top-left");
      view.ui.add("point-button", "top-left");
      view.ui.add("distanceSelectDiv", "top-right");
      view.ui.add(searchWidget, {
        position: "top-right",
        index: 2
      });


//---------------------------MISCELLANEOUS FUNCTIONS-----------------------
      //test if value is in array
      function isInArray(value, array) {
        return array.indexOf(value) > -1;
      }

      //order items in an array by the number of times they occur
      function orderByOccurrence(arr) {
          var counts = {};
          arr.forEach(function(value){
              if(!counts[value]) {
                  counts[value] = 0;
              }
              counts[value]++;
          });
          return Object.keys(counts).sort(function(curKey,nextKey) {
              return counts[curKey] > counts[nextKey];
          });
      }


//-----------------------------FUNCTIONS ASSOCIATED WITH THE VIEW-----------------------------------------
  //zoom to selected features, or zoom to the full extent of all layers if there are no selected features
      function zoomToLayer() {
        smallestX = 100000000;
        smallestY = 100000000;
        biggestX = 0;
        biggestY = 0;
        var totalFeatures = 0;
        for (h = 0; h < listOfLayers.length; h++) {
          totalFeatures += listOfLayers[h].source.length;
        }
        for (h = 0; h < listOfLayers.length; h++) {
          if (totalFeatures == 0)
          {
            layer = listOfBiblioFeatures2[h];
          }
          else {
            layer = listOfLayers[h];
          }
          if (layer.source){
            biblioFeatures = layer.source.toArray();
          }
          else {
            biblioFeatures = layer;
          }
          //find the largest and smallest x and y values for all points or polygons
          //on the map
          for (i = 0; i < biblioFeatures.length; i++) {
          //if the layers on the map are polygons
            if (biblioFeatures[i].geometry.centroid) {
              if (biblioFeatures[i].geometry.centroid.x < smallestX) {
                smallestX = biblioFeatures[i].geometry.centroid.x;
              }
              if (biblioFeatures[i].geometry.centroid.y < smallestY) {
                smallestY = biblioFeatures[i].geometry.centroid.y;
              }
              if (biblioFeatures[i].geometry.centroid.x > biggestX) {
                biggestX = biblioFeatures[i].geometry.centroid.x;
              }
              if (biblioFeatures[i].geometry.centroid.y > biggestY) {
                biggestY = biblioFeatures[i].geometry.centroid.y;
              }
            }

            else {
              //if the layers on the map are points
              if (biblioFeatures[i].geometry.x < smallestX) {
                smallestX = biblioFeatures[i].geometry.x;
              }
              if (biblioFeatures[i].geometry.y < smallestY) {
                smallestY = biblioFeatures[i].geometry.y;
              }
              if (biblioFeatures[i].geometry.x > biggestX) {
                biggestX = biblioFeatures[i].geometry.x;
              }
              if (biblioFeatures[i].geometry.y > biggestY) {
                biggestY = biblioFeatures[i].geometry.y;
              }
            }

          }
        }
        //create an extent out of the minimum and maximum extents of all visible features
        var xMargin = (biggestX - smallestX) * 0.25;
        var yMargin = (biggestY - smallestY) * 0.25;
        var extent = new Extent({
          xmin: smallestX - xMargin,
          ymin: smallestY - yMargin,
          xmax: biggestX + xMargin,
          ymax: biggestY + yMargin,
          spatialReference: {
            wkid: 102100
          }
        });
        //zoom to that extent
        view.goTo(extent);
      }

//every time the map zooms, update the layers being used to either points or polygons
//depending on the scale
     watchUtils.whenTrue(view, "stationary", function() {
       if (centroidLayer && view.scale > centroidLayer.maxScale) {
         listOfLayers = [];
         listOfLayers.push(centroidLayer);
         listOfLayers.push(centroidLayer2);
       }
      if (layer && view.scale < layer.minScale) {
         listOfLayers = [];
         listOfLayers.push(layer);
         listOfLayers.push(layer2);
       }
     });


      //---------------------------BEGIN VIEW.THEN----------------------
      //fires once the map is loaded.  all map activities must happen here
      view.then(function() {
  //---------------------------DEFINE LAYERS AND FIELDS-------------------------------
        var allLayers = map.allLayers.toArray();
        resultsShowing = false;
        document.getElementById("search").style.width = "26%";
        //uncomment this to get a list of all the layer ids on the map
        /*for (var i = 0; i < allLayers.length; i++) {
        console.log(allLayers[i].id);
      }*/
      //identify layers
      layerID = "TurkeySites1_shapefile_1005";
      layerID2 = "TurkeySites2_shapefile_3824";
      centroidLayerID = "TurkeyCentroids1_shapefile_7690";
      centroidLayerID2 = "TurkeyCentroids2_shapefile_1716";

      layer1 = map.findLayerById(layerID);
      layer2 = map.findLayerById(layerID2);
      centroidLayer = map.findLayerById(centroidLayerID);
      centroidLayer2 = map.findLayerById(centroidLayerID2);

      //create a list of all layers on the map
      listOfLayers.push(layer1);
      listOfLayers.push(layer2);
      listOfCentroids.push(centroidLayer);
      listOfCentroids.push(centroidLayer2);
      layer = layer1;

      //uncomment this to get all field names and indices
      /*for (var i = 0; i < layer.fields.length; i++){
      console.log("field index " + i + " is " + layer.fields[i].name);
      }*/

      zoomToLayer();

      //get the fields associated with author first, last and full name
      for (var i = 21; i < 60; i += 4) {
        listOfAuthorFields.push(layer.fields[i].name);
      }
      for (var i = 20; i < 60; i += 4) {
        listOfFirstNameFields.push(layer.fields[i].name);
      }
      for (var i = 19; i < 60; i += 4) {
        listOfLastNameFields.push(layer.fields[i].name);
      }

      //get fields associated with other relevant information
      englishTitle = layer.fields[12].name;
      turkishTitle = layer.fields[11].name;
      otherTitle = layer.fields[13].name;
      publication = layer.fields[3].name;
      language = layer.fields[14].name;
      pageStart = layer.fields[6].name;
      pageEnd = layer.fields[9].name;
      volume = layer.fields[4].name;
      number = layer.fields[5].name;
      uniqueID = layer.fields[2].name;


      //---------------------------ATTACH LISTENERS TO BUTTONS AND SELECTORS----------------------

      //move the search widget into the same div as the distance selector
      var widget = document.getElementsByClassName("esri-search");
      document.getElementById("distanceSelectDiv").appendChild(widget[0]);
      //change the function of the geocode button to open and close the geocoder search div
      var geocodeButton = document.getElementsByClassName("esri-search__submit-button")[0];
      var geocodeClone = geocodeButton.cloneNode(true);
      geocodeButton.parentNode.removeChild(geocodeButton);
      document.getElementById("distanceSelectDiv").appendChild(geocodeClone);
      var geocoderVisible = false;
      geocodeClone.addEventListener("click", function(){
        var searchContainer = document.getElementsByClassName("esri-search")[0];
        if (geocoderVisible == false) {
          document.getElementById("distance_select").style.display = "block";
          searchContainer.style.display = "block";
        }
        if (geocoderVisible == true) {
          document.getElementById("distance_select").style.display = "none";
          searchContainer.style.display = "none";
        }
        geocoderVisible = !geocoderVisible;
      });


      searchWidget.on("search-start", function(event){
        //change the function of the geocoder exit button to both clear the search and also re-run the
        //search without the geocoder results
        geocodeClearButton = document.getElementsByClassName("esri-search__clear-button")[0];
        var geocodeClearClone = geocodeClearButton.cloneNode(true);
        geocodeClearButton.parentNode.removeChild(geocodeClearButton);
        document.getElementsByClassName("esri-search__form")[0].appendChild(geocodeClearClone);
        geocodeClearClone.addEventListener("click", function(){
          clearPolygon();
          var images = document.getElementsByTagName('image');
          //get rid of the weird circle the geocoder created
          if (images.length > 0) {
            for (i = 0; i < images.length; i++) {
              images[i].parentNode.removeChild(images[i]);
            }
          }
          document.getElementById("polygonSearchTag").style.display = "none";
          for (var i = 0; i < view.graphics.length; i++) {
            view.graphics.remove(view.graphics.toArray()[i]);
          }
          view.popup.close();
          searchWidget.clear();
          filterByAll();
        });
      });

     document.getElementById("hideSearch").addEventListener("click", function() {
        if (document.getElementById("search").style.width == "26%") {
          document.getElementById("search").style.width = "0%";
          document.getElementById("viewDiv").style.width = "99%";
          document.getElementById("hideSearch").innerHTML = "Show";
          return;
        }

        if (document.getElementById("search").style.width == "0%") {
          document.getElementById("search").style.width = "26%";
          document.getElementById("viewDiv").style.width = "73%";
          document.getElementById("hideSearch").innerHTML = "Hide";
          return;
        }
      });

      //sort the results when the sort selector option is changed
      var sortSelector = document.getElementById("sortSelect");
      sortSelector.addEventListener("change", sortByField);


      //add show all button that will show and print all records and reset all searches
      var showAll = document.getElementById("showAll");
      showAll.addEventListener("click", function() {
        document.getElementById("sortSelect").selectedIndex = 0;
        document.getElementById("polygonSearchTag").style.display = "none";
        filterByList(biblioFeatures2);
        paginate(biblioFeatures2, false);
        linkRecordsToPopups();
        biblioFeatures3 = biblioFeatures2;
      });


      //clear the selection and reset the map when the clear button is clicked
      clearButton = document.getElementById("clear-button");
      clearButton.addEventListener("click", function() {
        document.getElementById("resultsCard").click();
        resultsShowing = false;
        checkedList = [];
        checkedList2 = [];
        document.getElementById("polygonSearchTag").style.display = "none";
        var images = document.getElementsByTagName('image');
        if (images.length > 0) {
          for (i = 0; i < images.length; i++) {
            images[i].parentNode.removeChild(images[i]);
          }
        }
        clearPolygon();
        allRecords.innerHTML = "";
        document.getElementById("sortSelectDiv").style.display = "none";
        document.getElementById("paginateDiv").innerHTML = "";
        if (searchByCircle == true) {
          pointButton.classList.toggle("esri-point-button-selected");
          searchByCircle = false;
        }
        if (drawing == true) {
          drawButton.classList.toggle("esri-draw-button-selected");
          deactivateDraw();
          drawing = false;
        }
        document.getElementById("distance_select").selectedIndex = 0;
        searchWidget.clear();
        view.popup.close();
        filterByList(biblioFeatures2);
        biblioFeatures3 = biblioFeatures2;
        zoomToLayer();
      });

      var searchBoxButton = document.getElementById("searchBoxButton");
      searchBoxButton.addEventListener("click", function() {
        filterByWord();
      });

      //clear the search by keyword box and redo the search when the x is clicked
      clearSearchButton = document.getElementById("clearSearchButton");
      clearSearchButton.addEventListener("click", function (){
        document.getElementById("searchInput").value = "";
        filterByAll();
      });

      //start drawing when the draw button is clicked
      drawButton = document.getElementById("draw-button");
      drawButton.addEventListener("click", function() {
        drawing = !drawing;
        var images = document.getElementsByTagName('image');
        if (images.length > 0) {
          for (i = 0; i < images.length; i++) {
            images[i].parentNode.removeChild(images[i]);
          }
        }
        drawButton.classList.toggle("esri-draw-button-selected");
        if (searchByCircle == true) {
          pointButton.classList.toggle("esri-point-button-selected");
          searchByCircle = false;
        }
        document.getElementById("distance_select").selectedIndex = 0;
        searchWidget.clear();
        view.popup.close();
        if (!drawConfig.isDrawActive) {
          activateDraw(biblioFeatures2);
        }
        else {
          deactivateDraw();
          clearPolygon();
        }
      });

      //select by point when the user clicks on the map
      pointButton = document.getElementById("point-button");
      pointButton.addEventListener("click", function() {
        if (searchByCircle == false) {
          activateDraw(biblioFeatures2);
        }
        //this is the only way to get rid of the graphic created by the geosearch
        var images = document.getElementsByTagName('image');
        if (images.length > 0) {
          for (i = 0; i < images.length; i++) {
            images[i].parentNode.removeChild(images[i]);
          }
        }
        if (searchByCircle == true) {
          document.getElementById("distance_select").selectedIndex = 0;
          clearPolygon();
        }
        searchByCircle = !searchByCircle;
        allRecords.innerHTML = "";
        pointButton.classList.toggle("esri-point-button-selected");
        searchWidget.clear();
        view.popup.close();
        if (drawing == true) {
          drawButton.classList.toggle("esri-draw-button-selected");
          drawing = false;
        }
      });

      //remove the polygon and redo the search when the polygon search tag
      //is cleared
      var clearPolygonTag = document.getElementById("clearPolygonTag");
      clearPolygonTag.addEventListener("click", function() {
        clearPolygon();
        document.getElementById("polygonSearchTag").style.display = "none";
        filterByAll();
      });

      //search by checklist when the checklist search button is clicked
      var filterButtons = document.getElementsByClassName("filterButton");
      for (var i = 0; i < filterButtons.length; i++) {
        filterButton = filterButtons[i];
        filterButton.addEventListener("click", function() {
          filterByAll();
        });
      }

      //register that the results are hidden when the intro or search tabs are clicked
      var introCard = document.getElementById("introCard");
      introCard.addEventListener("click", function(){
        resultsShowing = false;
      });

      var searchCard = document.getElementById("searchCard");
      searchCard.addEventListener("click", function(){
        resultsShowing = false;
      });



//----------------------INITIALIZING THE DISPLAY ----------------------------------
        //for each layer, create a list with all its features, then put each of those list
        //in a list.  listOfBiblioFeatures2 represents all possible features on the map divided
        //up among their source layer
        //Also, set an attribute "Main Title" which represents the title that is to be used for reference purposes
        //and which is the title in whatever language the text is in
        for (h = 0; h < listOfLayers.length; h++) {
          layer = listOfLayers[h];
          var biblioFeaturesLayer = [];
          var biblioFeatures = layer.source.toArray();
          for (var i = 0; i < biblioFeatures.length; i++) {
            if (biblioFeatures[i].attributes[language] == "Turkish"){
              biblioFeatures[i].setAttribute("MainTitle", biblioFeatures[i].attributes[turkishTitle]);
            }
            if (biblioFeatures[i].attributes[language] == "English"){
              biblioFeatures[i].setAttribute("MainTitle", biblioFeatures[i].attributes[englishTitle]);
            }
            if (biblioFeatures[i].attributes[language] == "French" || biblioFeatures[i].attributes[language] == "German"){
              biblioFeatures[i].setAttribute("MainTitle", biblioFeatures[i].attributes[otherTitle]);
            }
            biblioFeatures2.push(biblioFeatures[i]);
            biblioFeaturesLayer.push(biblioFeatures[i]);
          }
          var popupTemplate = new PopupTemplate();
          layer.popupTemplate = popupTemplate;
          popupTemplate.title = "{MainTitle}";
          popupTemplate.content = "test";
          listOfBiblioFeatures2.push(biblioFeaturesLayer);
        }

        for (h = 0; h < listOfCentroids.length; h++) {
          centroid = listOfCentroids[h];
          var centroidPoints = listOfCentroids[h].source.toArray();
          for (var a = 0; a < centroidPoints.length; a++) {
            if (centroidPoints[a].attributes[language] == "Turkish"){
              centroidPoints[a].setAttribute("MainTitle", centroidPoints[a].attributes[turkishTitle]);
            }
            if (centroidPoints[a].attributes[language] == "English"){
              centroidPoints[a].setAttribute("MainTitle", centroidPoints[a].attributes[englishTitle]);
            }
            if (centroidPoints[a].attributes[language] == "French" || centroidPoints[a].attributes[language] == "German"){
              centroidPoints[a].setAttribute("MainTitle", centroidPoints[a].attributes[otherTitle]);
            }
          }
            var popupTemplate = new PopupTemplate();
            centroid.popupTemplate = popupTemplate;
            popupTemplate.title = "{MainTitle}";
            popupTemplate.content = "test";
        }

        biblioFeatures3 = biblioFeatures2;

        //Popupate the desired divs in the search and browse based on div Id and field
        createBrowse("astksts_12", "astksts_12", true, biblioFeatures);
        createBrowse("astkstsa_1", "astkstsa_1", true, biblioFeatures);
        createBrowseMultiple(biblioFeatures, true);

        var checkboxes = document.getElementsByClassName("checkbox");
        var filterButtons = document.getElementsByClassName("filterButton");
        var browseDivs = document.getElementsByClassName("browse");
        var checkedList2;
        var textChecks;
        var pubChecks;

        for (var h = 0; h < browseDivs.length; h++) {
          browseDivs[h].addEventListener("click", function(e){
            checkedList2 = [];
            for (var i = 0; i < checkboxes.length; i++) {
              if (checkboxes[i].checked == true) {
                checkedList2.push(checkboxes[i]);
              }
            }
          });
        }


//------------------------------FILTER FUNCTIONS------------------------------

  //when a search criterion is removed, re-run the search with all remaining criteria
        function filterByAll() {
          document.getElementById("sortSelect").selectedIndex = 0;
          biblioFeatures3 = biblioFeatures2;
          checkedList = [];
          var filterList = [];
          var checkboxes = document.getElementsByClassName("checkbox");
            for (var i = 0; i < checkboxes.length; i++) {
              if (checkboxes[i].checked == true) {
                checkedList.push(checkboxes[i]);
              }
            }

          //if options are checked in the checklist
          if (checkedList.length != 0) {
            filterByCheckList();
          }
          //if the geometry search is active
          if (view.graphics.length !=0) {
            filterByGeometry(searchArea);
          }
          //if the keyword search is active
          if (document.getElementById("searchInput").value.length != 0) {
            filterByWord();
          }
          //if no filters remain, show all features
          if (checkedList.length == 0 && view.graphics.length ==0 && document.getElementById("searchInput").value.length == 0){
            filterByList(biblioFeatures2);
          }
          paginate(biblioFeatures3, false);
          linkRecordsToPopups();
          createBrowse("astksts_12", "astksts_12", false, biblioFeatures3);
          createBrowse("astkstsa_1", "astkstsa_1", false, biblioFeatures3);
          createBrowseMultiple(biblioFeatures3, false);
          recheckBoxes();
          zoomToLayer();
        }

        function filterByCheckList() {
          document.getElementById("sortSelect").selectedIndex = 0;
          var filterList = [];
          //if no boxes are checked, do nothing
          if (checkedList.length == 0) {
            return;
          }

          //get all the categories of search that have at least one box checked
          var nameList = [];
          for (var i = 0; i < checkedList.length; i++) {
            if (!isInArray(checkedList[i].name, nameList)){
              nameList.push(checkedList[i].name);
            }
          }
          //if a checklist search is being run on only one criteron
          if (nameList.length == 1) {
            for (var i = 0; i <biblioFeatures3.length; i++) {
              for (var j = 0; j < checkedList.length; j++) {
                var field = nameList[0];
                var value = checkedList[j].id;
                //if the criterion is author, search for currently displayed features that have a match for the selected author
                //in any of the author fields
                if (nameList[0] == "author") {
                  for (var k = 0; k < listOfAuthorFields.length; k++){
                    var field = listOfAuthorFields[k];
                    if (biblioFeatures3[i].attributes[field] == value && !isInArray(biblioFeatures3[i], filterList)){
                      filterList.push(biblioFeatures3[i]);
                    }
                  }
                }
                //otherwise, search for currently displayed features that have a match for the selected search field (which is the element name
                //of the selected checkbox)
                if (biblioFeatures3[i].attributes[field] == value && !isInArray(biblioFeatures3[i], filterList)){
                  filterList.push(biblioFeatures3[i]);
                }
              }
            }
          }
          //if more than one search criterion is checked, do the same thing as above, but create a list of lists of
          //features that match each criterion
          if (nameList.length > 1) {
            var listOfLists = [];
            for (var h = 0; h < nameList.length; h++) {
              var selectedList = [];
              for (var i = 0; i <biblioFeatures3.length; i++) {
                for (var j = 0; j < checkedList.length; j++) {
                  var field = nameList[h];
                  var value = checkedList[j].id;
                  if (field == "author") {
                    for (var k = 0; k < listOfAuthorFields.length; k++){
                      var field = listOfAuthorFields[k];
                      if (biblioFeatures3[i].attributes[field] == value && !isInArray(biblioFeatures3[i], filterList)){
                        selectedList.push(biblioFeatures3[i]);
                      }
                    }
                  }
                  else {
                    if (biblioFeatures3[i].attributes[field] == value && !isInArray(biblioFeatures3[i], selectedList)){
                      selectedList.push(biblioFeatures3[i]);
                    }
                  }
                }
              }
              listOfLists.push(selectedList);
            }
            //if there are two search criteria, select only the items in the second list that are also in the first list
            //(i.e. that match both criteria)
            if (!listOfLists[2]) {
              var list2 = listOfLists[1];
              for (i = 0; i <list2.length; i++) {
                if (isInArray(list2[i], listOfLists[0])){
                  filterList.push(list2[i]);
                }
              }
            }

            //if there are three search criteria, select only the items in the third list that are also in the first and second listOfLists
            //(i.e. that match all three criteria)
            if(listOfLists[2]) {
              var list3 = listOfLists[2];
              for (i = 0; i <list3.length; i++) {
                if (isInArray(list3[i], listOfLists[0]) && isInArray(list3[i], listOfLists[1])){
                  filterList.push(list3[i]);
                }
              }
            }
          }

          //set the currently selected features to the results of the checkList search
          biblioFeatures3 = filterList;

          //the current checklist will be remembered if non-checklist filter methods are used
          //subsequently
          checkedList2 = checkedList;
          //if no features match all of the selected criteria, add all the points back on the map;
          if (filterList == 0) {
            filterByList(biblioFeatures2);
          }
          //otherwise, put only those features which match all criteria on the map
          else{
            filterByList(filterList);
          }

          paginate(filterList, false);
          linkRecordsToPopups();
          recheckBoxes();
          var checkedBoxes = document.getElementsByClassName("checkbox");
        }//end filterByCheckList

    //filter by keyword
    function filterByWord () {
      document.getElementById("sortSelect").selectedIndex = 0;
      var searchTerm = document.getElementById("searchInput").value.toLowerCase();
      var fieldNames = [];
      for (var i = 0; i < layer.fields.length; i++){
        fieldNames.push(layer.fields[i].name);
      }
      searchList = [];
      //search for the keyword or phrase across all fields
      for (var i = 0; i < biblioFeatures3.length; i++) {
        for (var j = 0; j < fieldNames.length; j++){
          var field = fieldNames[j];
          if (biblioFeatures3[i].attributes[field]) {
            var fieldString = biblioFeatures3[i].attributes[field].toString().toLowerCase();
            if (fieldString.indexOf(searchTerm) !== -1 && !isInArray(biblioFeatures3[i], searchList)) {
              searchList.push(biblioFeatures3[i]);
            }
          }
        }
      }
      biblioFeatures3 = searchList;
      filterByList(searchList);
      paginate(searchList, false);
      linkRecordsToPopups();
    } //end fitlerByWord

    //display only selected points on the map
    function filterByList(selectedList) {
      for (h = 0; h < listOfLayers.length; h++) {
        layer = listOfLayers[h];
        biblioFeatures = [];
        var selectedListInLayer = [];
        var features = layer.source.toArray();
        var biblioFeatures22 = listOfBiblioFeatures2[h];
        for (g = 0; g < features.length; g++) {
          biblioFeatures.push(features[g]);
        }
        //match selected features with their layer of origin
        for (f = 0; f < selectedList.length; f++) {
          for (a = 0; a < biblioFeatures22.length; a++) {
            if (selectedList[f].attributes[uniqueID] == biblioFeatures22[a].attributes[uniqueID]) {
              selectedListInLayer.push(selectedList[f]);
            }
          }
        }
        //remove all features
        for (var i = 0; i < biblioFeatures.length; i++) {
          layer.source.remove(biblioFeatures[i]);
        }
        //add features back to their layer of origin
        for (var i = 0; i < selectedListInLayer.length; i++) {
          layer.source.add(selectedListInLayer[i]);
        }
      }
      var browse = document.getElementsByClassName("browse");
      for (var i = 0; i < browse.length; i++) {
        browse[i].innerHTML = "";
      }
      var polygonGraphic = view.graphics.length;
      createBrowse("astksts_12", "astksts_12", true, biblioFeatures3);
      createBrowse("astkstsa_1", "astkstsa_1", true, biblioFeatures3);
      createBrowseMultiple(biblioFeatures3, true);
    } //end filterByList


//----------------------------LISTEN FOR CLICKS ON THE MAP--------------------------
    view.on("click", function(evt) {
      //open a popup when a feature is clicked
      view.hitTest(evt).then(function(response) {
        var clickedList = [response.results[0].graphic];
        if (clickedList[0].attributes[language] == "Turkish"){
          clickedList[0].setAttribute("MainTitle", clickedList[0].attributes[turkishTitle]);
        }
        if (clickedList[0].attributes[language] == "English"){
          clickedList[0].setAttribute("MainTitle", clickedList[0].attributes[englishTitle]);
        }
        if (clickedList[0].attributes[language] == "French" || clickedList[0].attributes[language] == "German"){
          clickedList[0].setAttribute("MainTitle", clickedList[0].attributes[otherTitle]);
        }
        view.popup.close();
        view.popup = new Popup({
          title: clickedList[0].attributes["MainTitle"],
          location: evt.mapPoint,
          content: ''
        });
        view.popup.open()
      }).then();

    //if searching by circle, draw a line between two clicked points
    if (searchByCircle == true) {
      clicks++;
      var searchDistance = document.getElementById("distance_select").value;
      searchWidget.clear();
      if (clicks == 1 && searchByCircle == true) {
        firstPoint = evt.mapPoint;
        line.addPath([firstPoint]);
        return;
      }
      if (clicks == 2 && searchByCircle == true) {
        completeCircle(evt.mapPoint);
          }
        } //end if searchByCircle true
      }); //end view.onClick
    });  //end view.then
//------------------END VIEW.THEN---------------------------------------------

    function filterByGeometry(searchArea) {
      document.getElementById("sortSelect").selectedIndex = 0;
      var selectedList = [];
      for (h = 0; h < listOfLayers.length; h++) {
        layer = listOfLayers[h];
        biblioFeatures = layer.source.toArray();
        var includeDistance = false;
        //if the feature falls within the polygon, add it to a list and add a distance attribute
        for (var i = 0; i < biblioFeatures.length; i++){
          if (biblioFeatures[i].geometry.centroid) {
            var polygon = new Polygon(biblioFeatures[i].geometry);
            if (geometryEngine.intersects(searchArea, polygon) || geometryEngine.contains(searchArea, polygon)){
              if (searchArea.radius) {
                var center = new Point(searchArea.center);
                var distance = geometryEngine.distance(center, polygon, "miles").toFixed(2);
                biblioFeatures[i].setAttribute("Distance", distance);
              }
              selectedPoints.add(biblioFeatures[i]);
              selectedList.push(biblioFeatures[i]);
            }
          }
          else {
            var point = biblioFeatures[i].geometry;
            if (geometryEngine.contains(searchArea, point)){
              selectedPoints.add(biblioFeatures[i]);
              selectedList.push(biblioFeatures[i]);
            }
          }
        }
        biblioFeatures22 = listOfBiblioFeatures2[h];
        var selectedListInLayer2 = [];
        for (f = 0; f < selectedList.length; f++) {
          for (a = 0; a < biblioFeatures22.length; a++) {
            if (selectedList[f].attributes[uniqueID] == biblioFeatures22[a].attributes[uniqueID]) {
              selectedListInLayer2.push(selectedList[f]);
            }
          }
        }
        //remove all features
        for (var i = 0; i < biblioFeatures.length; i++) {
          layer.source.remove(biblioFeatures[i]);
        }
        //add features back to their layer of origin
        for (var i = 0; i < selectedListInLayer2.length; i++) {
          layer.source.add(selectedListInLayer2[i]);
        }
      }
      createBrowse("astksts_12", "astksts_12", false, selectedList);
      createBrowse("astkstsa_1", "astkstsa_1", false, selectedList);
      createBrowseMultiple(selectedList, false);
      var checkedBoxes = document.getElementsByClassName("checkbox");
      recheckBoxes();
      biblioFeatures3 = selectedList;
      //sort results by distance
      var sortedGraphics = selectedPoints.graphics.sort(function(a, b){
        if(parseFloat(a.attributes["Distance"]) > parseFloat(b.attributes["Distance"])){
          return 1;
        }
        else if (parseFloat(a.attributes["Distance"]) < parseFloat(b.attributes["Distance"])){
          return -1;
        }
        else {
          return 0;
        }
      });
      selectedPointsGraphics = sortedGraphics.toArray();
      paginate(selectedPointsGraphics, includeDistance);
      document.getElementById("polygonSearchTag").style.display = "block";
    } //end filterByGeometry


//----------------------------SEARCH WIDGET-------------------------------------
    searchWidget.on("search-complete", function(data) {

      clearPolygon();
      if (searchByCircle == true) {
        pointButton.classList.toggle("esri-point-button-selected");
        searchByCircle = false;
      }
      var distanceValue = document.getElementById("distance_select").value;
      var point2 = new Point(searchWidget.results[0].results[0].feature.geometry);
      circle2 = new Circle({
        center: point2,
        geodesic: false,
        radius: distanceValue,
        radiusUnit: "kilometers"
      });
      searchArea = circle2;
      var circleSymb = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL,
        new SimpleLineSymbol(
          SimpleLineSymbol.STYLE_SHORTDASHDOTDOT,
          new Color([105, 105, 105]),2), new Color([255, 255, 0, 0.25]));
          var graphic = new Graphic(circle2, circleSymb);
          view.graphics.add(graphic);

      filterByGeometry(searchArea);
      linkRecordsToPopups();
    });



//----------------------RIGHT SIDEBAR FUNCTIONS---------------------------------------
//for a given field name, get all values of that field, the number of records with
//that value, and add them to the given div in the search and browse
  function createBrowse(divId, fieldName, useLayer, selectedFeatures) {
    //divId indicates the div that will be populated
    //fieldName is the name of the field used to populate the div
    //useLayer indicates whether the browse should be created using the current value
    //of layer.source.  The text browse functions modify layer.source and thus this should be true.
    //The geographic search functions select points without modifying layer.source, so this value should be false
    //and the list of selected points should go in selectedFeatures
    var browseDiv = document.getElementById(divId);
    selectedList = [];
    browseDiv.innerHTML = "<form action=''>";
    if (useLayer == true) {
      for (h = 0; h < listOfLayers.length; h++) {
        layer = listOfLayers[h];
        var features = layer.source.toArray();
        for (g = 0; g < features.length; g++) {
          selectedList.push(features[g]);
        }
      }
    }
    if (useLayer == false) {
      selectedList = selectedFeatures;
    }
    var browseList = [];
    for (var i = 0; i < selectedList.length; i++) {
      var browseAttribute = selectedList[i].attributes[fieldName];
      if (browseAttribute && isInArray(browseAttribute, browseList) == false){
        browseList.push(browseAttribute);
      }
    }
    sortedList = browseList.sort();
    for (var i = 0; i < sortedList.length; i++) {
      var numberOfRecords = 0;
      for (var j = 0; j < selectedList.length; j++) {
        if (selectedList[j].attributes[fieldName] == sortedList[i]) {
          numberOfRecords ++;
        }
      }
      var div = document.createElement("div");
      div.innerHTML = "<input type='checkbox' name='" + browseDiv.id + "' class = 'checkbox' id='" + sortedList[i] +  "'>" + sortedList[i] + " (" + numberOfRecords + ")";
      div.id = sortedList[i] + "div";
      browseDiv.appendChild(div);
    }
    browseDiv.innerHTML += "</form>";
  } //end createBrowse

  function createBrowseMultiple(selectedFeatures, useLayer) {
    var browseDiv = document.getElementById("author");
    selectedList = [];
    browseDiv.innerHTML = "<form action=''>";
    if (useLayer == true) {
      for (h = 0; h < listOfLayers.length; h++) {
        layer = listOfLayers[h];
        var features = layer.source.toArray();
        for (g = 0; g < features.length; g++) {
          selectedList.push(features[g]);
        }
      }
    }
    if (useLayer == false) {
      selectedList = selectedFeatures;
    }
    var browseList = [];
    for (var i = 0; i < selectedList.length; i++) {
      for (j = 0; j < listOfAuthorFields.length; j++) {
        var fieldName = listOfAuthorFields[j];
        var browseAttribute = selectedList[i].attributes[fieldName];
        if (browseAttribute && browseAttribute != " "){
          browseList.push(browseAttribute);
        }
      }
    }
    sortedByOccurence = orderByOccurrence(browseList);
    sortedList = sortedByOccurence.reverse();
    for (var i = 0; i < sortedList.length; i++) {
      var numberOfRecords = 0;
      var lastNameField;
      var lastName;
      var firstNameField;
      var firstName;
      for (var j = 0; j < selectedList.length; j++) {
        for (k = 0; k < listOfAuthorFields.length; k++) {
          var fieldName = listOfAuthorFields[k];
          if (selectedList[j].attributes[fieldName] == sortedList[i]) {
            lastNameField = listOfLastNameFields[k];
            firstNameField = listOfFirstNameFields[k];
            lastName = selectedList[j].attributes[lastNameField];
            firstName = selectedList[j].attributes[firstNameField];
            numberOfRecords ++;
          }
        }
      }
      var div = document.createElement("div");
      div.innerHTML = "<input type='checkbox' name='" + browseDiv.id + "' class = 'checkbox' id='" + sortedList[i] +  "'>" + lastName + ", " + firstName + " (" + numberOfRecords + ")";
      div.id = sortedList[i] + "div";
      browseDiv.appendChild(div);
    }
    browseDiv.innerHTML += "</form>";
  } //end createBrowseMultiple


  function recheckBoxes() {
    var checkedBoxes = document.getElementsByClassName("checkbox");
    //match the current checkboxes displayed with the old checkboxes that were checked before,
    //and recheck them
    for (var i = 0; i < checkedBoxes.length; i++) {
      for (var j = 0; j < checkedList.length; j++) {
        if (checkedBoxes[i].id == checkedList[j].id) {
          checkedBoxes[i].checked = true;
          textId = checkedBoxes[i].id + "div";
          document.getElementById(textId).style.color = "purple";
        }
      }
    }
  } //end recheckBoxes



//-------------------------LEFT SIDEBAR-----------------------
//divide the results into sets of 10 and attach click listeners to page numbers
  function paginate(recordList, includeDistance) {
  //  alert(recordList.length);
    var paginateNumbers = document.getElementById("paginateDiv");
    if (recordList.length < 11) {
      paginateNumbers.innerHTML = "";
      createRecordDivs(recordList, includeDistance);
    }

    else {
      var pageList = [];
      var numberOfPages = Math.ceil(recordList.length / 10);
      for (i = 0; i < 10; i++) {
        pageList.push(recordList[i]);
      }
      createRecordDivs(pageList, includeDistance);
      paginateNumbers.innerHTML = "";
      var listOfNumbers = [];
      for (var i = 1; i < numberOfPages + 1; i++) {
        var div = document.createElement("div");
        div.tagName = i.toString();
        div.innerHTML = "<a href = #>" + i.toString() + "</a>";
        div.className = "paginate";
        paginateNumbers.appendChild(div);
        div.addEventListener("click", makeClickCallbackPaginate(i, recordList, includeDistance))
      }
    }
  } //end paginate

  function makeClickCallbackPaginate(i, recordList, includeDistance) {
    //when a page number is clicked, show the appropriate page of results
    function callbackPaginate(e) {
      var rangeStart = (i - 1) * 10;
      var rangeEnd = (i * 10);
      var pageList2 = [];
      for (j = rangeStart; j < rangeEnd; j++) {
        if (recordList[j]) {
          pageList2.push(recordList[j]);
        }
      }
      createRecordDivs(pageList2, includeDistance);
      }
      return callbackPaginate;
    } //end makeClickCallbackPaginate

//for each selected record, put it in a div that corresponds to its unique id number,
//and print its field names and attributes

  function createRecordDivs(recordList, includeDistance) {
    document.getElementById("sortSelectDiv").style.display = "block";
    allRecords.innerHTML = "";
    if (recordList.length == 0) {
      allRecords.innerHTML = "<br/> No results matched your search.  Please search again.";
      return;
    }
    for (var i = 0; i < recordList.length; i++) {
      var idNo = recordList[i].attributes[uniqueID];
      var biggerDiv =  document.createElement("div");
      var div = document.createElement("div");
      if (recordList[i].attributes[uniqueID]) {
        div.id = "point" + idNo;
      }
      if (!recordList[i].attributes[uniqueID]) {
        div.id = "point0";
      }
      div.className = "record";
      biggerDiv.id = "big" + div.id;
      if (recordList[i].attributes[englishTitle] && recordList[i].attributes[englishTitle] != " ") {
        div.innerHTML += "<b> English Title: </b>" + recordList[i].attributes[englishTitle] + "<br/>";
      }
      if (recordList[i].attributes[turkishTitle] && recordList[i].attributes[turkishTitle] != " ") {
        div.innerHTML += "<b>Turkish Title: </b>" + recordList[i].attributes[turkishTitle] + "<br/>";
      }
      if (recordList[i].attributes[otherTitle] && recordList[i].attributes[otherTitle] != " ") {
        div.innerHTML += "<b> Other Title: </b>" + recordList[i].attributes[otherTitle] + "<br/>";
      }
      div.innerHTML += "<b> Authors: </b>";
      var firstAuthor = listOfAuthorFields[0];
      if (recordList[i].attributes[firstAuthor]) {
        div.innerHTML += recordList[i].attributes[firstAuthor];
      }
      for (var j = 1; j < listOfAuthorFields.length; j++) {
        var authorField = listOfAuthorFields[j];
        if (recordList[i].attributes[authorField] && recordList[i].attributes[authorField] != " "){
          div.innerHTML += ", " + recordList[i].attributes[authorField];
        }
      }
      div.innerHTML += "<br/>";
      if (publication) {
        div.innerHTML += "<b>Publication: </b>" + recordList[i].attributes[publication] + "<br/>";
      }
      if (recordList[i].attributes["Distance"] && includeDistance == true) {
        div.innerHTML += "<b>Distance:</b> " + recordList[i].attributes["Distance"] + "<br/>";
      }
      allRecords.appendChild(biggerDiv);
      biggerDiv.appendChild(div);

      //create citations and put them in a popup
      var allCitationDiv = document.createElement("div");
      allCitationDiv.id = "allCitation" + div.id;
      allCitationDiv.className = "allCitation";
      biggerDiv.appendChild(allCitationDiv);
      var closeDiv = document.createElement("div");
      closeDiv.innerHTML = "<a href = '#'> &#10761; </a>";
      closeDiv.className = "citationClose";
      closeDiv.id = "citationClose" + div.id;
      allCitationDiv.appendChild(closeDiv);
      var harvardDiv = document.createElement("div");
      allCitationDiv.appendChild(harvardDiv);
      var harvardTitleDiv = document.createElement("div");
      harvardTitleDiv.innerHTML = "<a href = '#'> Harvard" + "<span style = 'font-size:9px'>     &#x25BC; </span> </a>"
      harvardTitleDiv.href = "#";
      harvardTitleDiv.id = "harvard" + div.id;
      harvardDiv.appendChild(harvardTitleDiv);
      var harvardCitation = document.createElement("div");
      harvardCitation.id = "harvardCitation" + div.id;
      harvardCitation.className = "citation";
      harvardDiv.appendChild(harvardCitation);
      var mlaDiv = document.createElement("div");
      allCitationDiv.appendChild(mlaDiv);
      var mlaTitleDiv = document.createElement("div");
      mlaTitleDiv.innerHTML = "<a href = '#'> MLA" +  "<span style = 'font-size:9px'>     &#x25BC; </span> </a>"
      mlaTitleDiv.id = "MLA" + div.id;
      mlaDiv.appendChild(mlaTitleDiv);
      var mlaCitation = document.createElement("div");
      mlaCitation.id = "mlaCitation" + div.id;
      mlaCitation.className = "citation";
      mlaDiv.appendChild(mlaCitation);
      var chicagoDiv = document.createElement("div");
      allCitationDiv.appendChild(chicagoDiv);
      var chicagoTitleDiv = document.createElement("div");
      chicagoTitleDiv.innerHTML = "<a href = '#'> Chicago" +  "<span style = 'font-size:9px'>    &#x25BC; </span> </a>"
      chicagoTitleDiv.id = "Chicago" + div.id;
      chicagoDiv.appendChild(chicagoTitleDiv);
      var chicagoCitation = document.createElement("div");
      chicagoCitation.id = "chicagoCitation" + div.id;
      chicagoCitation.className = "citation";
      chicagoDiv.appendChild(chicagoCitation);
      var alaDiv = document.createElement("div");
      allCitationDiv.appendChild(alaDiv);
      var alaTitleDiv = document.createElement("div");
      alaTitleDiv.innerHTML = "<a href = '#'> ALA" +  "<span style = 'font-size:9px'>     &#x25BC; </span> </a>"
      alaTitleDiv.id = "ALA" + div.id;
      alaDiv.appendChild(alaTitleDiv);
      var alaCitation = document.createElement("div");
      alaCitation.id = "alaCitation" + div.id;
      alaCitation.className = "citation";
      alaDiv.appendChild(alaCitation);
      biggerDiv.innerHTML += "<button type='button' class = 'citeButton' tag ='" + i + "'id = 'cite" + div.id + "'>Export Citation</button>";
    }
  } //end createRecordDivs

  //sort records by the chosen field
  function sortByField() {
    var sortValue = document.getElementById("sortSelect").value;
    var field;
    if (sortValue == "Title") {
      field = "MainTitle"
    }
    if (sortValue == "Author") {
      field = listOfLastNameFields[0];
    }
    biblioSort = biblioFeatures3.sort(function(a, b){
      if(a.attributes[field] > b.attributes[field]){
        return 1;
      }
      else if (a.attributes[field] < b.attributes[field]){
        return -1;
      }
      else {
        return 0;
      }
    });
    paginate(biblioSort,false);
  } //end sortByField


//print all records, sorted by English title
  function printAllRecords() {
    biblioFeatures = layer.source.toArray();
    allRecords = document.getElementById("allRecords");
    var sortedAll = biblioFeatures.sort(function(a, b){
      if(a.attributes[englishField] > b.attributes[englishField]){
        return 1;
      }
      else if (a.attributes[englishField] < b.attributes[englishField]){
        return -1;
      }
      else {
        return 0;
      }
    });
    paginate(biblioFeatures2, false);
    linkRecordsToPopups();
  } //end printAllRecords

//attach click listeners to divs
  function linkRecordsToPopups() {
    if (resultsShowing == false) {
    document.getElementById("resultsCard").click();
    resultsShowing = true;
  }
    zoomToLayer();
    for (var i = 1; i < biblioFeatures2.length + 1; i++){
      var divName = "point" + i.toString();
      //open the corresponding popup when a result is clicked
      if (document.getElementById(divName)){
        document.getElementById(divName).addEventListener("click", makeClickCallback(i, biblioFeatures2))
      }
      //open the citation window when the button is clicked
      var buttonId = "citepoint" + i.toString();
      if (document.getElementById(buttonId)){
        document.getElementById(buttonId).addEventListener("click", makeClickCallback3(i));
      }
      //open each citation format when it's clicked
      var harvardTitle = "harvardpoint" + i.toString();
      if (document.getElementById(harvardTitle)){
        document.getElementById(harvardTitle).addEventListener("click", makeClickCallbackCitation(i, "harvard"));
      }
      var mlaTitle = "MLApoint" + i.toString();
      if (document.getElementById(mlaTitle)){
        document.getElementById(mlaTitle).addEventListener("click", makeClickCallbackCitation(i, "mla"));
      }

      var chicagoTitle = "Chicagopoint" + i.toString();
      if (document.getElementById(chicagoTitle)){
        document.getElementById(chicagoTitle).addEventListener("click", makeClickCallbackCitation(i, "chicago"));
      }
      var alaTitle = "ALApoint" + i.toString();
      if (document.getElementById(alaTitle)){
        document.getElementById(alaTitle).addEventListener("click", makeClickCallbackCitation(i, "ala"));
      }
      //close the citation window when the x is clicked
      var closeButton = "citationClosepoint" + i.toString();
      if (document.getElementById(closeButton)){
        document.getElementById(closeButton).addEventListener("click", makeClickCallbackClose(i));
      }
    }
  } //end linkRecordsToPopups


  //open popup when a record div is clicked
  function makeClickCallback(i, biblioFeatures2) {
    function callback(e){
      for (h = 0; h < listOfLayers.length; h++) {
        biblioFeatures22 = listOfBiblioFeatures2[h];
        for (k = 0; k < biblioFeatures22.length; k++) {
          if (biblioFeatures22[k].attributes[uniqueID] == i) {
            var popupTitle;
            if (biblioFeatures22[k].attributes[language] == "Turkish") {
              popupTitle = turkishTitle;
            }
            if (biblioFeatures22[k].attributes[language] == "English") {
              popupTitle = englishTitle;
            }
            if (biblioFeatures22[k].attributes[language] == "Other") {
              popupTitle = otherTitle;
            }
            view.popup = new Popup({
              title: biblioFeatures22[k].attributes[popupTitle],
              location: biblioFeatures22[k].geometry.centroid,
              content: ''
            });
          }
        }
        view.popup.open()
      }
    }
    return callback;
  } //end makeClickCallback

  //display citations for individual formats
  function makeClickCallbackCitation(i, style) {
      function callbackCitation(e) {
        var citationID = style + "Citationpoint" + i;
        var citation = document.getElementById(citationID);
        if (!citation.style.display || citation.style.display == "none") {
          citation.style.display = "block";
          return;
        }
        if (citation.style.display == "block") {
          citation.style.display = "none";
          return;
        }
      }
      return callbackCitation;
  } //end makeClickCallbackCitation

  //create the citations
  function makeClickCallback3(i) {
    function callback3(e){
      var firstLastName = listOfLastNameFields[0];
      var firstFirstName = listOfFirstNameFields[0];
      var authorCitation = biblioFeatures2[i].attributes[firstLastName] + ", " + biblioFeatures2[i].attributes[firstFirstName];
      var secondLastName = listOfLastNameFields[1];
      var secondFirstName = listOfFirstNameFields[1];
      var thirdLastName = listOfLastNameFields[2];
      var thirdFirstName = listOfFirstNameFields[2];
      if (biblioFeatures2[i].attributes[secondLastName] && biblioFeatures2[i].attributes[secondLastName] != " ") {
        for (var j = 1; j < listOfLastNameFields.length; j++) {
          var name = listOfAuthorFields[j];
          if (biblioFeatures2[i].attributes[name] != " " && biblioFeatures2[i].attributes[name]) {
            if (j != listOfLastNameFields.length - 1) {
              var nextField = listOfLastNameFields[j + 1];
              if (biblioFeatures2[i].attributes[nextField] == " " && biblioFeatures2[i].attributes[name]) {
                authorCitation += " and " + biblioFeatures2[i].attributes[name];
              }
              else if (biblioFeatures2.attributes[name]){
                authorCitation += biblioFeatures2[i].attributes[name] + ", ";
              }
            }
            if (j == listOfLastNameFields.length - 1) {
              authorCitation += " and " + biblioFeatures2[i].attributes[name];
            }
          }
        }
      }
      var titleCitation;
      if (biblioFeatures2[i].attributes[language] == "English") {
        titleCitation = biblioFeatures2[i].attributes[englishTitle];
      }
      if (biblioFeatures2[i].attributes[language] == "Turkish") {
        titleCitation = biblioFeatures2[i].attributes[turkishTitle];
      }
      if (biblioFeatures2[i].attributes[language] != "Turkish" && biblioFeatures2[i].attributes[language] != "English") {
        titleCitation = biblioFeatures2[i].attributes[otherTitle];
      }
      var dateField = "";
      var chicagoCitation = authorCitation+ '. ' +
      '"' + titleCitation + '."' + biblioFeatures2[i].attributes[publication].italics() + ' no. ' +
      biblioFeatures2[i].attributes[volume] + ' (' + biblioFeatures2[i].attributes[dateField] + '): ' + biblioFeatures2[i].attributes[pageStart] +
      '-' + biblioFeatures2[i].attributes[pageEnd] + '.';
      var harvardCitation = authorCitation + '. ' + biblioFeatures2[i].attributes[dateField] +
      ", " + '"' + titleCitation + '", ' + biblioFeatures2[i].attributes[publication] + ", vol. " + biblioFeatures2[i].attributes[volume] +
      ", pp. " +  biblioFeatures2[i].attributes[pageStart] + '-' + biblioFeatures2[i].attributes[pageEnd] + '.'
      var mlaCitation = authorCitation + '. ' +
      '"' + titleCitation + '."' + biblioFeatures2[i].attributes[publication].italics() + ' vol. ' +
      biblioFeatures2[i].attributes[volume] + ", " + biblioFeatures2[i].attributes[dateField] + ", pp. " +  biblioFeatures2[i].attributes[pageStart] + '-' +
      biblioFeatures2[i].attributes[pageEnd] + '.';
      var apaCitation = authorCitation + '. ' +
      '(' + biblioFeatures2[i].attributes[dateField] + '). ' + titleCitation + '. ' +
      biblioFeatures2[i].attributes[publication].italics() + ', ' +  biblioFeatures2[i].attributes[volume].toString().italics() + ', ' +
      biblioFeatures2[i].attributes[pageStart] + '-' + biblioFeatures2[i].attributes[pageEnd] + '.';
      var allCitationDiv = "allCitationpoint" + i;
      var harvardDiv = "harvardCitationpoint" + i;
      var harvardCitationDiv = document.getElementById(harvardDiv);
      harvardCitationDiv.innerHTML = harvardCitation;
      var chicagoDiv = "chicagoCitationpoint" + i;
      var chicagoCitationDiv = document.getElementById(chicagoDiv);
      chicagoCitationDiv.innerHTML = chicagoCitation;
      var mlaDiv = "mlaCitationpoint" + i;
      var mlaCitationDiv = document.getElementById(mlaDiv);
      mlaCitationDiv.innerHTML = mlaCitation;
      var alaDiv = "alaCitationpoint" + i;
      var alaCitationDiv = document.getElementById(alaDiv);
      alaCitationDiv.innerHTML = apaCitation;
      document.getElementById(allCitationDiv).style.display = "block";
    }
    return callback3;
  }

  //hide the citation window when the x is clicked
  function makeClickCallbackClose(i) {
    function callbackClose(e) {
      var divID = "allCitationpoint" + i;
      document.getElementById(divID).style.display = "none";
    }
    return callbackClose;
  } //end makeClickCallbackClose


//-------------------------DRAWING FUNCTIONS-----------------------------------
function activateDraw(biblioFeatures2) {
  drawConfig.isDrawActive = true;
  clearPolygon();
  pointerDownListener = view.on("pointer-down", function(event) {
    event.stopPropagation();
    var point = createPoint(event);
    addVertex(point);
  });  //end point down

  pointerMoveListener = view.on("pointer-move", function(event) {
    if (drawConfig.activePolygon) {
      event.stopPropagation();
      var point = createPoint(event);
      updateFinalVertex(point);
    }
  }); //end point move

  //finish the shape and stop drawing on double click
  doubleClickListener = view.on("double-click", function(event) {
    if (searchByCircle == true) {
      completeCircle(event.mapPoint);
    }
    else {
      event.stopPropagation();
      searchArea = addVertex(event.mapPoint, true);
      if (!searchArea) {
        return null;
      }
      deactivateDraw();
      drawButton.classList.toggle("esri-draw-button-selected");
      drawing = false;
      //select the points that fall within the drawn polygon
      filterByGeometry(searchArea);
      linkRecordsToPopups();
    }
  }) //end double click
}//end activte draw

  //stop drawing
  function deactivateDraw() {
    drawConfig.isDrawActive = false;
    pointerDownListener.remove();
    pointerMoveListener.remove();
    doubleClickListener.remove();
    drawConfig.activePolygon = null;
  } //end deactivate draw

  function createPoint(event) {
    return view.toMap(event);
  } //end createPoint

  function addVertex(point, isFinal) {
    var polygon = drawConfig.activePolygon;
    var ringLength;
    if (!polygon) {
      polygon = new Polygon({
        spatialReference: {
          wkid: 3857
        }
      });
      polygon.addRing([point, point]);
    } else {
      ringLength = polygon.rings[0].length;
      polygon.insertPoint(0, ringLength - 1, point);
    }
    drawConfig.activePolygon = polygon;
    return redrawPolygon(polygon, isFinal);
  }

  //remove the polygon or circle from the map
  function clearPolygon() {
    var polygonGraphic = view.graphics.find(function(graphic) {
      return graphic.geometry.type === "polygon";
    });
    if (polygonGraphic) {
      view.graphics.remove(polygonGraphic);
    }
    var polygonGraphic2 = view.graphics.find(function(graphic) {
      return graphic.geometry.type === "polyline";
    });
    if (polygonGraphic2) {
      view.graphics.remove(polygonGraphic2);
    }
    //clear the list of selected points
    if (selectedPointsGraphics) {
      for (var i = selectedPointsGraphics.length - 1; i>-1; i--) {
        selectedPoints.remove(selectedPointsGraphics[i]);
      }
    }
  } //end clear polygon

  function redrawPolygon(polygon, finished) {
    var geometry = finished ? geometryEngine.simplify(polygon) :
    polygon;

    if (!geometry && finished) {
      console.log(
        "Cannot finish polygon. It must be a triangle at minimum. Resume drawing..."
      );
      return null;
    }

    clearPolygon();

    var polygonGraphic = new Graphic({
      geometry: geometry,
      symbol: finished ? drawConfig.finishedSymbol : drawConfig.drawingSymbol
    });

    view.graphics.add(polygonGraphic);
    return geometry;
  } //end redraw polygon

  function updateFinalVertex(point) {
    var polygon = drawConfig.activePolygon.clone();
    var ringLength = polygon.rings[0].length;
    polygon.insertPoint(0, ringLength - 1, point);
    redrawPolygon(polygon);

  } //end update final vertex

  //create circle when done drawing
  function completeCircle(secondPoint) {
    deactivateDraw();
    clearPolygon();
    pointButton.classList.toggle("esri-point-button-selected");
    searchByCircle = false;
    secondPoint = secondPoint;
    line.addPath([secondPoint]);
    line.spatialReference = view.spatialReference;
    view.graphics.add(new Graphic(line, lineSymbol));
    var lineDistance = geometryEngine.distance(firstPoint,secondPoint, "kilometers");
    circle = new Circle({
      center: firstPoint,
      geodesic: false,
      radius: lineDistance,
      radiusUnit: "kilometers"
    });
    var circleSymb = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL,
      new SimpleLineSymbol(
        SimpleLineSymbol.STYLE_SHORTDASHDOTDOT,
        new Color([105, 105, 105]),2), new Color([255, 255, 0, 0.25]));
    var graphic = new Graphic(circle, circleSymb);
    view.graphics.add(graphic);
    filterByGeometry(circle);
    linkRecordsToPopups();
    clicks = 0;
    return;
  } //end completeCircle
}); //end all

//this gets rid of the error "Bootstrap tooltips requires tether", since this script doesn't use Boostrap tooltips
window.Tether = {};

</script>
</head>
<body class="claro">
  <div id = "header">
    <div id = "pageTitle"> Turkish Archaeology Geographical Bibliography
      <a href = "map-tr.html"><div id="translate_button" class="esri-widget-button esri-widget esri-interactive" style = "float:right" >
        View page in English
      </div>
    </a>
  </div>
  <div id="searchBox" style = "margin-left:6px">
    <input id = "searchInput" type="text" class="searchTerm" placeholder="Enter search term">
    <button id = "searchBoxButton" type="submit" class="searchButton"> Search
    </button>
    <button id = "clearSearchButton" type="submit" class="searchButton"> Clear
    </button>
  </div>
  <a href = "#"><div id = "hideSearch"> Hide </div></a>
</div>
<div id="viewDiv">
</div>
<div id = "search" >
  <div id = "allButtons">
    <div id = "showAll" class = "searchButton allButton esri-widget-button esri-widget esri-interactive"> Show all </div>
    <div id="clear-button" class="allButton esri-widget-button esri-widget esri-interactive">
      Clear selection
    </div>
  </div>
  <div id="draw-button" title = "Select by polygon" class="esri-widget-button esri-widget esri-interactive">
    <span class="esri-icon-polygon"></span>
  </div>
  <div id = "distanceSelectDiv" style = "margin-bottom:10px">
    <select id="distance_select" class="selector">
      <option value="init">(select distance)</option>
      <option value = "20">20 kilometers </option>
      <option value = "50">50 kilometers </option>
      <option value = "100">100 kilometers </option>
      <option value = "200">200 kilometers </option>
      <option value = "2000">2000 kilometers </option>
    </select>
  </div>
  <div id="point-button" title = "Select by circle" class="esri-widget-button esri-widget esri-interactive"><div style = "font-size:30px">&#9900;</div></div>
  <div id = "geocoder"></div>
  <div id = "polygonSearchTag">
    <span> Geometry search </span>
    <div id = "clearPolygonTag" style = "width:10px; height: 10px"><a href = "#" style = "color:#b9b5b5"> &#10761; </a></div>
  </div>
  <div id="accordion" role="tablist">
    <div class="card">
      <div class="card-header" role="tab" id="headingOne">
        <h5 class="mb-0">
          <a id = "introCard" data-toggle="collapse" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            Introduction
          </a>
        </h5>
      </div>
      <div id="collapseOne" class="collapse show" role="tabpanel" aria-labelledby="headingOne" data-parent="#accordion">
        <div class="card-body">
          This site contains a collection of journal articles related to Turkish archaeology.  You can search by language, publication or author.
          You can also search by drawing a line between two points on the map, by drawing a polygon on the map, or by searching an address and selecting a proximity.
        </div>
      </div>
    </div> <!-- End intro card -->
    <div class="card">
      <div class="card-header" role="tab" id="headingTwo">
        <h5 class="mb-0">
          <a id = "searchCard" data-toggle="collapse" href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
            Search
          </a>
        </h5>
      </div>
      <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo" data-parent="#accordion">
        <div class="card-body">
          <a class="btn btn-primary" data-toggle="collapse" href="#multiCollapseExample1" aria-expanded="false" aria-controls="multiCollapseExample1">Search by language</a>
          <div class = "border"></div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse" id="multiCollapseExample1">
                <div class="card card-body">
                  <div id = "astksts_12" class = "browse"></div>
                  <button type="button" class = "filterButton" id = "filter1">Search</button>
                </div>
              </div>
            </div>
          </div>
          <a class="btn btn-primary" data-toggle="collapse" href="#multiCollapseExample2" aria-expanded="false" aria-controls="multiCollapseExample2">Search by publication</a>
          <div class = "border"></div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse" id="multiCollapseExample2">
                <div class="card card-body">
                  <div id = "astkstsa_1" class = "browse"></div>
                  <button type="button" class = "filterButton" id = "filter2">Search</button>
                </div>
              </div>
            </div>
          </div>
          <a class="btn btn-primary" data-toggle="collapse" href="#multiCollapseExample3" aria-expanded="false" aria-controls="multiCollapseExample3">Search by author</a>
          <div class = "border"></div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse" id="multiCollapseExample3">
                <div class="card card-body">
                  <div id = "author" class = "browse"></div>
                  <button type="button" class = "filterButton" id = "filter3">Search</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- end search card -->
    <div class="card">
      <div class="card-header" role="tab" id="headingThree">
        <h5 class="mb-0">
          <a id = "resultsCard" data-toggle="collapse" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
            Results
          </a>
        </h5>
      </div>
      <div id="collapseThree" class="collapse" role="tabpanel" aria-labelledby="headingThree" data-parent="#accordion">
        <div class="card-body">
          <div id = "paginateDiv"></div>
          <span></span>
          <br/>
          <div id = "sortSelectDiv">
            <select id = "sortSelect">
              <option value = "init">(sort by field)</option>
              <option value = "Title">Title</option>
              <option value = "Author">Author</option>
              <option value = "Date">Date</option>
            </select>
          </div>
          <div id = "allRecords"></div>
        </div>
      </div>
    </div> <!--end results card -->
  </div> <!--end accordion -->
</div>


<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
</body>
<script>
</script>
</html>
